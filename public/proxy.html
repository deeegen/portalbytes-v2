<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PortalBytes</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;400&display=swap"
      rel="stylesheet"
    />
    <link href="./assets/css/proxy.css" rel="stylesheet" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: "Montserrat", sans-serif;
      }
      .fullscreen-iframe iframe {
        width: 100vw;
        height: 100vh;
        border: none;
      }
      .fullscreen-mode {
        overflow: hidden;
      }
      .loading-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 90vh;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 100;
        cursor: pointer;
      }
      .loading-bg img {
        width: 64px;
        height: 64px;
      }
      .loading-text {
        color: white;
        margin-top: 10px;
        font-size: 1rem;
      }
      .proxy-iframe-wrapper {
        position: relative;
      }
    </style>
  </head>

  <body>
    <div class="proxy-container">
      <div class="proxy-header">
        <span class="proxy-title"
          >Proxy Portal <span class="proxy-version">v2.1</span></span
        >
        <form
          id="searchForm"
          style="display: flex; align-items: center; gap: 8px"
        >
          <input
            type="text"
            id="urlInput"
            placeholder="Enter URL"
            style="
              padding: 6px 12px;
              border-radius: 6px;
              border: none;
              width: 240px;
              font-size: 0.9rem;
            "
            autocomplete="off"
          />
          <button
            type="submit"
            style="
              padding: 6px 12px;
              background-color: #2d084f;
              color: #f7e017;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-weight: bold;
            "
          >
            Go
          </button>
        </form>
        <button id="fullscreenToggle" aria-label="Toggle Fullscreen">
          <i class="bi bi-fullscreen"></i>
        </button>
      </div>

      <div class="proxy-iframe-wrapper">
        <div
          class="loading-bg"
          id="loadingBg"
          style="
            align-items: center;
            justify-content: center;
            flex-direction: column;
          "
          title="Double-click to close loading overlay"
        >
          <img src="/assets/star-spinning.gif" alt="Loading..." />
          <div class="loading-text">Loading...</div>
        </div>
        <iframe
          id="proxyIframe"
          allowfullscreen
          style="width: 100%; height: 90vh; border: none"
        ></iframe>
      </div>
    </div>

    <script>
      let currentProxyMode = "corrosion"; // default fallback

      async function fetchProxyMode() {
        try {
          const res = await fetch("/api/proxy-mode");
          if (res.ok) {
            const data = await res.json();
            if (data.mode) {
              currentProxyMode = data.mode;
            }
          }
        } catch (e) {
          console.warn("Failed to fetch proxy mode", e);
        }
      }

      const iframe = document.getElementById("proxyIframe");
      const loadingBg = document.getElementById("loadingBg");
      const urlInput = document.getElementById("urlInput");

      function validateAndProcessUrl(input) {
        const patterns = [
          /^https?:\/\/.+/i,
          /^\/\/.+/,
          /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(\/.*)?$/,
          /^(?:\d{1,3}\.){3}\d{1,3}(:\d+)?(\/.*)?$/,
          /^localhost(:\d+)?(\/.*)?$/i,
        ];
        return patterns.some((pattern) => pattern.test(input));
      }

      async function goToUrl(rawUrl) {
        if (!rawUrl) return;

        let inputValue = rawUrl.trim();

        // Proxy mode logic integration
        if (currentProxyMode === "alloy") {
          // For alloy mode: encode input URL and redirect
          if (
            !inputValue.startsWith("http://") &&
            !inputValue.startsWith("https://")
          ) {
            inputValue = "http://" + inputValue;
          }
          const encodedValue = btoa(inputValue);
          window.location.href = "/web/_" + encodedValue + "_/";
          return;
        }

        // corrosion mode logic
        const isUrl = validateAndProcessUrl(inputValue);
        const iframeMode =
          localStorage.getItem("settings_iframeMode") === "true";
        let targetUrl;

        if (isUrl) {
          targetUrl = inputValue.startsWith("http")
            ? inputValue
            : "http://" + inputValue;
        } else {
          targetUrl =
            "https://www.qwant.com/?q=" + encodeURIComponent(inputValue);
        }

        loadingBg.style.display = "flex";

        if (iframeMode) {
          sessionStorage.setItem("proxyUrl", targetUrl);
          window.location.href = "/proxy.html";
        } else {
          try {
            iframe.src =
              "/service/gateway?url=" + encodeURIComponent(targetUrl);
            sessionStorage.setItem("gatewayUrl", targetUrl);
          } catch (err) {
            loadingBg.style.display = "none";
            console.error("Failed to set iframe source:", err);
          }
        }
      }

      iframe.onload = function () {
        loadingBg.style.display = "none";

        try {
          const doc = iframe.contentDocument || iframe.contentWindow.document;

          if (!doc.querySelector("#nav-monitor")) {
            const script = doc.createElement("script");
            script.id = "nav-monitor";
            script.textContent = `
              document.body.addEventListener('click', (e) => {
                const el = e.target.closest('a[href]');
                if (el && el.href) {
                  window.parent.postMessage('iframe-start-loading', '*');
                }
              }, true);

              window.addEventListener('beforeunload', () => {
                window.parent.postMessage('iframe-start-loading', '*');
              });
            `;
            doc.head.appendChild(script);
          }
        } catch (err) {
          console.warn("Iframe script injection failed:", err);
        }
      };

      window.addEventListener("message", (event) => {
        if (event.data === "iframe-start-loading") {
          loadingBg.style.display = "flex";
        }
      });

      document
        .getElementById("searchForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!urlInput) return;
          const inputUrl = urlInput.value.trim();
          if (inputUrl) await goToUrl(inputUrl);
        });

      async function init() {
        await fetchProxyMode();

        const savedUrl =
          sessionStorage.getItem("proxyUrl") ||
          sessionStorage.getItem("gatewayUrl");

        if (savedUrl && typeof savedUrl === "string") {
          await goToUrl(savedUrl);
        } else {
          loadingBg.style.display = "flex";
          const loadingText = loadingBg.querySelector(".loading-text");
          if (loadingText) loadingText.textContent = "No URL provided.";
        }
      }

      // Allow users to double-click the loading overlay to dismiss it
      loadingBg.addEventListener("dblclick", () => {
        loadingBg.style.display = "none";
        const loadingText = loadingBg.querySelector(".loading-text");
        if (loadingText) loadingText.textContent = "Loading...";
      });

      const fullscreenBtn = document.getElementById("fullscreenToggle");
      const container = document.querySelector(".proxy-container");

      fullscreenBtn.addEventListener("click", () => {
        if (!container) return;

        const isFullscreen = container.classList.toggle("fullscreen-iframe");
        document.body.classList.toggle("fullscreen-mode", isFullscreen);

        const icon = fullscreenBtn.querySelector("i");
        if (icon) {
          icon.classList.toggle("bi-fullscreen", !isFullscreen);
          icon.classList.toggle("bi-fullscreen-exit", isFullscreen);
        }

        const header = document.querySelector(".proxy-header");
        if (header) {
          header.style.display = isFullscreen ? "none" : "flex";
        }
      });

      document.addEventListener("keydown", (e) => {
        if (
          e.key === "Escape" &&
          container.classList.contains("fullscreen-iframe")
        ) {
          container.classList.remove("fullscreen-iframe");
          document.body.classList.remove("fullscreen-mode");

          const header = document.querySelector(".proxy-header");
          if (header) header.style.display = "flex";

          const icon = fullscreenBtn.querySelector("i");
          if (icon) {
            icon.classList.remove("bi-fullscreen-exit");
            icon.classList.add("bi-fullscreen");
          }
        }
      });

      try {
        history.replaceState({}, "", location.origin + "/");
      } catch (e) {
        console.warn("Failed to update browser history:", e);
      }

      // Initialize after DOM loaded
      window.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
