<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Settings</title>
    <style>
      body {
        font-family: "Comic Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #121224 100%);
        color: #eee;
        margin: 0;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        height: 100vh;
        box-sizing: border-box;
        /* Removed animated starfield */
        background-image: none;
        animation: none;
      }

      h1 {
        font-family: "Orbitron", sans-serif;
        font-weight: 700;
        font-size: 2.5em;
        margin-bottom: 0.3em;
        color: #fffb00;
        text-shadow: 0 0 8px #fffb00, 0 0 20px #fffb00, 0 0 30px #fffb00,
          0 0 40px #fff700;
        animation: glowPulse 3s infinite alternate;
        letter-spacing: 0.08em;
      }

      @keyframes glowPulse {
        0% {
          text-shadow: 0 0 8px #fffb00, 0 0 20px #fffb00, 0 0 30px #fffb00,
            0 0 40px #fff700;
        }
        100% {
          text-shadow: 0 0 12px #fffb00, 0 0 28px #fffb00, 0 0 40px #fffb00,
            0 0 60px #fff700;
        }
      }

      label {
        display: flex;
        align-items: center;
        font-size: 1.2em;
        gap: 12px;
        cursor: pointer;
        user-select: none;
        transition: color 0.3s ease;
      }
      label:hover {
        color: #fffb00;
        text-shadow: 0 0 6px #fffb00;
      }

      input[type="checkbox"] {
        width: 28px;
        height: 28px;
        cursor: pointer;
        border: 2px solid #fffb00;
        border-radius: 6px;
        background: transparent;
        transition: background-color 0.25s ease, box-shadow 0.3s ease;
        position: relative;
        box-sizing: border-box;
      }

      input[type="checkbox"]:checked {
        background: #fffb00;
        box-shadow: 0 0 8px #fffb00 inset;
      }

      input[type="checkbox"]:checked::after {
        content: "✓";
        color: #1a1a2e;
        font-weight: bold;
        position: absolute;
        top: 2px;
        left: 6px;
        font-size: 18px;
        pointer-events: none; /* Ensures only one symbol and no interference */
      }

      input[type="radio"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        border: 2px solid #fffb00;
        border-radius: 50%;
        background: transparent;
        transition: background-color 0.25s ease, box-shadow 0.3s ease;
        position: relative;
        box-sizing: border-box;
      }

      input[type="radio"]:checked {
        background: #fffb00;
        box-shadow: 0 0 8px #fffb00 inset;
      }

      input[type="radio"]:checked::after {
        content: "●";
        color: #1a1a2e;
        font-weight: bold;
        position: absolute;
        top: -2px;
        left: 3px;
        font-size: 12px;
        pointer-events: none;
      }

      input[type="text"],
      input[type="url"] {
        padding: 12px 16px;
        font-size: 1.1em;
        width: 100%;
        border: 2px solid transparent;
        border-radius: 12px;
        margin-top: 8px;
        box-sizing: border-box;
        background: #2a2a4e;
        color: #eee;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        box-shadow: inset 0 0 8px #121224;
      }

      input[type="text"]:focus,
      input[type="url"]:focus {
        outline: none;
        border-color: #fffb00;
        box-shadow: 0 0 12px #fffb00;
        background: #1a1a2e;
      }

      button {
        background: #fffb00;
        color: #000;
        font-weight: 900;
        border: none;
        border-radius: 12px;
        padding: 14px 20px;
        font-size: 1.2em;
        cursor: pointer;
        transition: background 0.3s ease, box-shadow 0.3s ease,
          transform 0.2s ease;
        display: none; /* Hidden since auto-save is enabled */
        box-shadow: 0 4px 8px rgba(255, 251, 0, 0.6);
        user-select: none;
      }

      button:hover {
        background: #fff400;
        box-shadow: 0 6px 14px rgba(255, 251, 0, 0.9);
        transform: scale(1.05);
      }

      .footer {
        margin-top: auto;
        font-size: 0.85em;
        color: #888;
        text-align: center;
        font-style: italic;
        letter-spacing: 0.05em;
      }

      .section {
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: #121224;
        padding: 20px;
        border-radius: 14px;
        box-shadow: 0 0 15px #0f0f1e, inset 0 0 8px #fffb00;
        transition: box-shadow 0.4s ease;
      }
      .section:hover {
        box-shadow: 0 0 25px #fffb00, inset 0 0 14px #fffb00;
      }

      .proxy-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 10px;
      }

      .proxy-option {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-message {
        color: #0f0;
        margin-top: 10px;
        font-size: 1em;
      }
    </style>
  </head>
  <body>
    <h1>Settings</h1>

    <label>
      <input type="checkbox" id="iframeModeToggle" />
      Enable Iframe Mask
    </label>

    <label>
      <input type="checkbox" id="showBookmarksToggle" />
      Show Bookmarks
    </label>

    <div class="section">
      <label>Proxy Backend Selection</label>
      <div class="proxy-options">
        <div class="proxy-option">
          <input
            type="radio"
            id="corrosionProxy"
            name="proxyBackend"
            value="corrosion"
          />
          <label for="corrosionProxy">Corrosion Proxy</label>
        </div>

        <div class="proxy-option">
          <input
            type="radio"
            id="alloyProxy"
            name="proxyBackend"
            value="alloy"
          />
          <label for="alloyProxy">Alloy Proxy</label>
        </div>
      </div>
      <div id="proxyStatusMessage" class="status-message"></div>
    </div>

    <div class="section">
      <label>
        <input type="checkbox" id="enableCustomKeybind" />
        Enable Custom Keybind
      </label>

      <div>
        <label for="keybindInput">Keybind</label>
        <input
          type="text"
          id="keybindInput"
          placeholder="Ctrl+Shift+R"
          disabled
        />
      </div>

      <div>
        <label for="redirectUrl">Redirect URL</label>
        <input type="url" id="redirectUrl" placeholder="https://example.com" />
      </div>

      <button id="saveRedirect">Save Keybind Settings</button>
      <div id="statusMessage" style="color: #0f0"></div>
    </div>

    <div class="footer">Changes are saved automatically.</div>

    <script>
      const iframeToggle = document.getElementById("iframeModeToggle");
      const bookmarksToggle = document.getElementById("showBookmarksToggle");
      const customKeybindToggle = document.getElementById(
        "enableCustomKeybind"
      );
      const keybindInput = document.getElementById("keybindInput");
      const redirectUrlInput = document.getElementById("redirectUrl");
      const statusMessage = document.getElementById("statusMessage");
      const proxyRadios = document.querySelectorAll(
        'input[name="proxyBackend"]'
      );
      const proxyStatusMessage = document.getElementById("proxyStatusMessage");

      const DEFAULT_KEYBIND = "ctrl+shift+r";

      // Load toggles
      iframeToggle.checked =
        localStorage.getItem("settings_iframeMode") === "true";
      bookmarksToggle.checked =
        localStorage.getItem("settings_showBookmarks") !== "false";

      iframeToggle.addEventListener("change", () => {
        localStorage.setItem("settings_iframeMode", iframeToggle.checked);
      });

      bookmarksToggle.addEventListener("change", () => {
        localStorage.setItem("settings_showBookmarks", bookmarksToggle.checked);
        // Notify parent window of change:
        window.parent.postMessage(
          {
            type: "settings_showBookmarks_changed",
            value: bookmarksToggle.checked,
          },
          "*"
        );
      });

      // Proxy Backend Management
      function loadProxyBackend() {
        const savedBackend =
          localStorage.getItem("settings_proxyBackend") || "corrosion";
        const radioButton = document.querySelector(
          `input[value="${savedBackend}"]`
        );
        if (radioButton) {
          radioButton.checked = true;
        }
      }

      function saveProxyBackend() {
        const selectedRadio = document.querySelector(
          'input[name="proxyBackend"]:checked'
        );
        if (!selectedRadio) return;

        const selectedBackend = selectedRadio.value;
        localStorage.setItem("settings_proxyBackend", selectedBackend);

        // Notify parent window of proxy backend change
        window.parent.postMessage(
          {
            type: "proxy_backend_changed",
            value: selectedBackend,
          },
          "*"
        );

        proxyStatusMessage.textContent = `Proxy backend set to ${selectedBackend}. Changes will take effect immediately.`;
        setTimeout(() => (proxyStatusMessage.textContent = ""), 3000);
      }

      // Initialize proxy backend settings
      loadProxyBackend();

      // Add event listeners for proxy backend selection
      proxyRadios.forEach((radio) => {
        radio.addEventListener("change", saveProxyBackend);
      });

      // Load keybind settings
      const savedCustom =
        localStorage.getItem("custom_keybind_enabled") === "true";
      const savedKeybind =
        localStorage.getItem("redirect_keybind") || DEFAULT_KEYBIND;
      const savedURL = localStorage.getItem("redirect_url") || "";

      customKeybindToggle.checked = savedCustom;
      keybindInput.disabled = !savedCustom;
      keybindInput.value = savedKeybind;
      redirectUrlInput.value = savedURL;

      function autoSaveKeybindSettings() {
        const useCustom = customKeybindToggle.checked;
        const keybind = useCustom ? keybindInput.value.trim() : DEFAULT_KEYBIND;
        const url = redirectUrlInput.value.trim();

        localStorage.setItem("custom_keybind_enabled", useCustom);
        localStorage.setItem("redirect_keybind", keybind);
        localStorage.setItem("redirect_url", url);

        statusMessage.textContent = "Settings saved!";
        setTimeout(() => (statusMessage.textContent = ""), 2000);
      }

      customKeybindToggle.addEventListener("change", () => {
        const enabled = customKeybindToggle.checked;
        keybindInput.disabled = !enabled;
        autoSaveKeybindSettings();
      });

      keybindInput.addEventListener("input", autoSaveKeybindSettings);
      redirectUrlInput.addEventListener("input", autoSaveKeybindSettings);

      function parseKeybind(str) {
        return str
          .toLowerCase()
          .replace(/\s+/g, "")
          .split("+")
          .sort()
          .join("+");
      }

      document.addEventListener("keydown", (e) => {
        const parts = [];
        if (e.ctrlKey) parts.push("ctrl");
        if (e.shiftKey) parts.push("shift");
        if (e.altKey) parts.push("alt");
        if (e.metaKey) parts.push("meta");

        const key =
          e.key.length === 1 ? e.key.toLowerCase() : e.key.toLowerCase();
        if (!["control", "shift", "alt", "meta"].includes(key)) {
          parts.push(key);
        }

        const pressed = parts.sort().join("+");

        if (window.parent !== window) {
          window.parent.postMessage(
            {
              type: "keybind-pressed",
              keybind: pressed,
            },
            "*"
          );
        }
      });
    </script>
  </body>
</html>
