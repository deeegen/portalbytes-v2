<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Settings</title>
    <link href="./assets/css/settings.css" rel="stylesheet" />
  </head>
  <body>
    <h1>Settings</h1>

    <label>
      <input type="checkbox" id="iframeModeToggle" />
      Enable Iframe Mask
    </label>

    <label>
      <input type="checkbox" id="showBookmarksToggle" />
      Show Bookmarks
    </label>

    <div class="section">
      <label>Proxy Backend Selection</label>
      <div class="proxy-options">
        <div class="proxy-option">
          <input
            type="radio"
            id="corrosionProxy"
            name="proxyBackend"
            value="corrosion"
          />
          <label for="corrosionProxy">Corrosion Proxy</label>
        </div>

        <div class="proxy-option">
          <input
            type="radio"
            id="alloyProxy"
            name="proxyBackend"
            value="alloy"
          />
          <label for="alloyProxy">Alloy Proxy</label>
        </div>
      </div>
      <div id="proxyStatusMessage" class="status-message"></div>
    </div>

    <div class="section">
      <label>
        <input type="checkbox" id="enableCustomKeybind" />
        Enable Custom Keybind
      </label>

      <div>
        <label for="keybindInput">Keybind</label>
        <input
          type="text"
          id="keybindInput"
          placeholder="Ctrl+Shift+R"
          disabled
        />
      </div>

      <div>
        <label for="redirectUrl">Redirect URL</label>
        <input type="url" id="redirectUrl" placeholder="https://example.com" />
      </div>

      <button id="saveRedirect">Save Keybind Settings</button>
      <div id="statusMessage" style="color: #0f0"></div>
    </div>

    <div class="footer">Changes are saved automatically.</div>

    <script>
      const iframeToggle = document.getElementById("iframeModeToggle");
      const bookmarksToggle = document.getElementById("showBookmarksToggle");
      const customKeybindToggle = document.getElementById(
        "enableCustomKeybind"
      );
      const keybindInput = document.getElementById("keybindInput");
      const redirectUrlInput = document.getElementById("redirectUrl");
      const statusMessage = document.getElementById("statusMessage");
      const proxyRadios = document.querySelectorAll(
        'input[name="proxyBackend"]'
      );
      const proxyStatusMessage = document.getElementById("proxyStatusMessage");

      const DEFAULT_KEYBIND = "ctrl+shift+r";

      // Load toggles
      iframeToggle.checked =
        localStorage.getItem("settings_iframeMode") === "true";
      bookmarksToggle.checked =
        localStorage.getItem("settings_showBookmarks") !== "false";

      iframeToggle.addEventListener("change", () => {
        localStorage.setItem("settings_iframeMode", iframeToggle.checked);
      });

      bookmarksToggle.addEventListener("change", () => {
        localStorage.setItem("settings_showBookmarks", bookmarksToggle.checked);
        // Notify parent window of change:
        window.parent.postMessage(
          {
            type: "settings_showBookmarks_changed",
            value: bookmarksToggle.checked,
          },
          "*"
        );
      });

      // Proxy Backend Management
      function loadProxyBackend() {
        const savedBackend =
          localStorage.getItem("settings_proxyBackend") || "corrosion";
        const radioButton = document.querySelector(
          `input[value="${savedBackend}"]`
        );
        if (radioButton) {
          radioButton.checked = true;
        }
      }

      function saveProxyBackend() {
        const selectedRadio = document.querySelector(
          'input[name="proxyBackend"]:checked'
        );
        if (!selectedRadio) return;

        const selectedBackend = selectedRadio.value;
        localStorage.setItem("settings_proxyBackend", selectedBackend);

        // Notify parent window of proxy backend change
        window.parent.postMessage(
          {
            type: "proxy_backend_changed",
            value: selectedBackend,
          },
          "*"
        );

        proxyStatusMessage.textContent = `Proxy backend set to ${selectedBackend}. Changes will take effect immediately.`;
        setTimeout(() => (proxyStatusMessage.textContent = ""), 3000);
      }

      // Initialize proxy backend settings
      loadProxyBackend();

      // Add event listeners for proxy backend selection
      proxyRadios.forEach((radio) => {
        radio.addEventListener("change", saveProxyBackend);
      });

      // Load keybind settings
      const savedCustom =
        localStorage.getItem("custom_keybind_enabled") === "true";
      const savedKeybind =
        localStorage.getItem("redirect_keybind") || DEFAULT_KEYBIND;
      const savedURL = localStorage.getItem("redirect_url") || "";

      customKeybindToggle.checked = savedCustom;
      keybindInput.disabled = !savedCustom;
      keybindInput.value = savedKeybind;
      redirectUrlInput.value = savedURL;

      function autoSaveKeybindSettings() {
        const useCustom = customKeybindToggle.checked;
        const keybind = useCustom ? keybindInput.value.trim() : DEFAULT_KEYBIND;
        const url = redirectUrlInput.value.trim();

        localStorage.setItem("custom_keybind_enabled", useCustom);
        localStorage.setItem("redirect_keybind", keybind);
        localStorage.setItem("redirect_url", url);

        statusMessage.textContent = "Settings saved!";
        setTimeout(() => (statusMessage.textContent = ""), 2000);
      }

      customKeybindToggle.addEventListener("change", () => {
        const enabled = customKeybindToggle.checked;
        keybindInput.disabled = !enabled;
        autoSaveKeybindSettings();
      });

      keybindInput.addEventListener("input", autoSaveKeybindSettings);
      redirectUrlInput.addEventListener("input", autoSaveKeybindSettings);

      function parseKeybind(str) {
        return str
          .toLowerCase()
          .replace(/\s+/g, "")
          .split("+")
          .sort()
          .join("+");
      }

      document.addEventListener("keydown", (e) => {
        const parts = [];
        if (e.ctrlKey) parts.push("ctrl");
        if (e.shiftKey) parts.push("shift");
        if (e.altKey) parts.push("alt");
        if (e.metaKey) parts.push("meta");

        const key =
          e.key.length === 1 ? e.key.toLowerCase() : e.key.toLowerCase();
        if (!["control", "shift", "alt", "meta"].includes(key)) {
          parts.push(key);
        }

        const pressed = parts.sort().join("+");

        if (window.parent !== window) {
          window.parent.postMessage(
            {
              type: "keybind-pressed",
              keybind: pressed,
            },
            "*"
          );
        }
      });
    </script>
  </body>
</html>
